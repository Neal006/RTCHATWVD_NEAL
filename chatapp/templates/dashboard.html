<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard | Real-Time Chat</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      display: flex;
      background: #0f172a;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #user-panel {
      width: 30%;
      background: #1e293b;
      padding: 20px;
      overflow-y: auto;
      border-right: 2px solid #334155;
      box-sizing: border-box;
    }
    #user-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #searchInput {
      background-color: #334155;
      color: white;
      padding-left: 36px;
      background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
      background-repeat: no-repeat;
      background-position: 10px center;
      border: none;
      border-radius: 6px;
      outline: none;
      transition: box-shadow 0.2s;
    }
    #searchInput:focus {
      box-shadow: 0 0 0 2px #38bdf8;
    }
    #results {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #results li {
      margin-bottom: 10px;
    }
    #results li a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 16px;
      display: block;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    #results li a:hover {
      background-color: #475569;
    }
    #chat-panel {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    #chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1e293b;
      padding: 10px 20px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
    }
    #chat-title {
      font-size: 1.2em;
      font-weight: 600;
    }
    #call-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
      transition: background 0.2s;
    }
    #call-btn:hover svg {
      filter: brightness(1.3);
    }
    #messages {
      flex-grow: 1;
      overflow-y: auto;
      background-color: #1e293b;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 20px;
      list-style: none;
    }
    #messages li {
      position: relative;
      margin: 8px 0;
      padding: 10px 16px 20px 16px;
      border-radius: 10px;
      max-width: 70%;
      word-wrap: break-word;
      background-color: #334155;
      align-self: flex-start;
    }
    .own-message {
      background-color: #2563eb;
      color: #fff;
      align-self: flex-end;      /* Right side */
      margin-left: auto;
      margin-right: 0;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 10px;
    }
    .other-message {
      background-color: #334155;
      color: #fff;
      align-self: flex-start;    /* Left side */
      margin-right: auto;
      margin-left: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 10px;
    }
    .msg-meta {
      position: absolute;
      left: 12px;
      bottom: 4px;
      font-size: 0.75em;
      color: #cbd5e1;
    }
    #msg {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      flex-grow: 1;
      margin-right: 10px;
      background-color: #334155;
      color: white;
      box-sizing: border-box;
    }
    #msg_input {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      flex-grow: 1;
      margin-right: 10px;
      background-color: #334155;
      color: white;
      box-sizing: border-box;
      outline: none;
      transition: box-shadow 0.2s;
    }
    #msg_input:focus {
      box-shadow: 0 0 0 2px #38bdf8;
    }
    button {
      padding: 12px 20px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #1e40af;
    }
    #input-container {
      display: flex;
    }
    .day-divider {
      text-align: center;
      color: #94a3b8;
      background: none;
      font-size: 0.9em;
      margin: 16px 0 8px 0;
      padding: 0;
      border: none;
    }
    .selected {
      outline: 2px solid #38bdf8;
      background: #1e293b;
    }
    #msg-options {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    #msg-options button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.85em;
      cursor: pointer;
    }
    #msg-options button:hover {
      background: #1e40af;
    }
    .notif-badge {
      color: #f87171;
      font-size: 1.2em;
      margin-left: 6px;
      vertical-align: middle;
    }
    
  </style>
</head>
<body>

  <div id="user-panel">
    <h3>Search Users</h3>
    <input
      type="text"
      id="searchInput"
      onkeyup="searchUsers()"
      placeholder="Search users..."
      autocomplete="off"
    />
    <ul id="results"></ul>
    <button id="logout-btn" onclick="logout()" style="margin-top: 20px; padding: 10px 15px; border:none; border-radius:6px; background:#ef4444; color:white; cursor:pointer; width: 100%;">Logout</button>
  </div>

  <div id="chat-panel">
    <div id="chat-header">
      <span id="chat-title">Chat</span>
      <button id="call-btn" onclick="startCall()" title="Video Call">
        <svg width="28" height="28" fill="#38bdf8" viewBox="0 0 24 24"><path d="M17 10.5V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3.5l4 4v-11l-4 4z"/></svg>
      </button>
    </div>
    <ul id="messages"></ul>
    <div id="input-container">
      <form onsubmit="sendMessage(); return false;">
        <input id="msg_input" autocomplete="off" onkeydown="if(event.key === 'Enter') sendMessage();" />
        <button type="submit">Send</button>
      </form>
    </div>
    <div id="video-call" style="display:none; flex-direction:column; align-items:center;">
      <video id="localVideo" autoplay muted playsinline style="width:200px; border-radius:8px; background:#222;"></video>
      <video id="remoteVideo" autoplay playsinline style="width:200px; border-radius:8px; background:#222; margin-top:10px;"></video>
      <button onclick="endCall()" style="margin-top:10px; background:#ef4444;">End Call</button>
    </div>
  </div>
  <script>
    const socket = io(window.location.origin);
    socket.on('connect', () => {
      const lastTarget = localStorage.getItem('lastTargetUser');
      if (lastTarget) {
        openChat(lastTarget);  
      }
    });

    let room = '';
    let targetUser = '';
    const username = "{{ username }}";
    let localStream, peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    
    let currentRoom = '';
    let previousRoom = '';

    window.addEventListener('beforeunload', function() {
      if (currentRoom) socket.emit('leave', { room: currentRoom });
    });
    socket.on('private_message', function(msg) {
      if (
        (msg.sender === targetUser && msg.receiver === username) ||
        (msg.sender === username && msg.receiver === targetUser)
      ) {
        appendMessage(msg, msg.sender === username);
        scrollMessagesToBottom();
      } else {
        showNotification(msg.sender);
      }
    });
    function searchUsers() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        document.getElementById('results').innerHTML = '';
        return;
      }
      fetch(`/search_users?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const results = document.getElementById('results');
          results.innerHTML = '';
          data.forEach(user => {
            if (user !== username) {
              const li = document.createElement('li');
              li.innerHTML = `<a href="#" onclick="openChat('${user}')">${user}</a>`;
              results.appendChild(li);
            }
          });
        });
    }

    function showNotification(user) {
      const results = document.getElementById('results');
      const items = results.querySelectorAll('li a');
      items.forEach(a => {
        if (a.textContent === user && !a.querySelector('.notif-badge')) {
          const badge = document.createElement('span');
          badge.className = 'notif-badge';
          badge.textContent = 'â€¢';
          a.appendChild(badge);
        }
      });
    }

    function openChat(selectedUser) {
      if (!selectedUser) return;

      targetUser = selectedUser;
      previousRoom = currentRoom;
      currentRoom = [username, targetUser].sort().join('_');
      room = currentRoom;

      document.getElementById('chat-title').innerText = `Chat with ${targetUser}`;
      document.getElementById('messages').innerHTML = '';

      // Remove notif badge
      const results = document.getElementById('results');
      const items = results.querySelectorAll('li a');
      items.forEach(a => {
        if (a.textContent === targetUser) {
          const badge = a.querySelector('.notif-badge');
          if (badge) badge.remove();
        }
      });

      if (previousRoom && previousRoom !== currentRoom) {
        socket.emit('leave', { room: previousRoom });
      }

      socket.emit('join', { room: currentRoom });
      localStorage.setItem('lastTargetUser', selectedUser);
      loadMessages(targetUser);
    }

    function loadMessages(targetUser) {
      fetch(`/load_messages?target=${encodeURIComponent(targetUser)}`)
        .then(response => response.json())
        .then(messages => {
          const messagesList = document.getElementById('messages');
          messagesList.innerHTML = '';
          let lastDate = '';
          messages.forEach(msg => {
            const msgDate = msg.timestamp.split(' ')[0];
            if (msgDate !== lastDate) {
              insertDayDivider(new Date(msgDate).toLocaleDateString());
              lastDate = msgDate;
            }
            appendMessage(msg, msg.sender === username);
          });
          scrollMessagesToBottom();
        });
    }

    function sendMessage() {
      const messageInput = document.getElementById('msg_input');
      const message = messageInput.value.trim();
      if (!message || !room) return;

      socket.emit('private_message', {
        sender: username,
        receiver: targetUser,
        message: message
      });

      messageInput.value = '';
      scrollMessagesToBottom();
    }

    function scrollMessagesToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }

    function logout() {
      window.location.href = "/logout";
    }

    function startCall() {
      if (!targetUser) return alert("Select a user to call!");
      if (!navigator.mediaDevices) return alert("Browser doesn't support video call");
      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        localStream = stream;
        document.getElementById('localVideo').srcObject = stream;
        document.getElementById('video-call').style.display = 'flex';
        peerConnection = new RTCPeerConnection(config);
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        peerConnection.onicecandidate = ({candidate}) => {
          if (candidate) socket.emit('webrtc_ice', {candidate, to: targetUser, from: username});
        };
        peerConnection.ontrack = ({streams: [remoteStream]}) => {
          document.getElementById('remoteVideo').srcObject = remoteStream;
        };
        peerConnection.createOffer().then(offer => {
          peerConnection.setLocalDescription(offer);
          // Sending the offer
          socket.emit("video-call-offer", { recipient_id: targetUser, offer: offer });
        });
      });
    }

    // Receiving the offer
    socket.on("video-call-offer", (data) => {
      console.log("Received video call offer:", data);
    });

    function endCall() {
      if (peerConnection) peerConnection.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      document.getElementById('video-call').style.display = 'none';
      document.getElementById('remoteVideo').srcObject = null;
      document.getElementById('localVideo').srcObject = null;
      socket.emit('webrtc_end', {to: targetUser, from: username});
    }

    function insertDayDivider(dateStr) {
      const divider = document.createElement('li');
      divider.className = 'day-divider';
      divider.textContent = dateStr;
      document.getElementById('messages').appendChild(divider);
    }
    let selectedMsg = null;

    function appendMessage(msg, isOwn) {
      const li = document.createElement('li');
      li.className = isOwn ? 'own-message' : 'other-message';
      let time = msg.timestamp?.split(' ')[1]?.slice(0,5) || new Date().toTimeString().slice(0,5);
      li.innerHTML = `<div class="msg-content">${msg.sender}: ${msg.content}</div><div class="msg-meta">${time}</div>`;
      document.getElementById('messages').appendChild(li);
    }

    document.addEventListener('DOMContentLoaded', function() {
      searchUsers();
      // const lastTarget = localStorage.getItem('lastTargetUser');
      // if (lastTarget) openChat(lastTarget);
    });
  </script>
</body>
</html>