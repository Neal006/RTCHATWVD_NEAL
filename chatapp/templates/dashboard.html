<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard | Real-Time Chat</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      display: flex;
      background: #0f172a;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    #user-panel {
      width: 30%;
      background: #1e293b;
      padding: 20px;
      overflow-y: auto;
      border-right: 2px solid #334155;
      box-sizing: border-box;
    }
    #user-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #searchInput {
      background-color: #334155;
      color: white;
      padding-left: 36px;
      background-image: url('data:image/svg+xml;utf8,<svg fill="gray" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
      background-repeat: no-repeat;
      background-position: 10px center;
      border: none;
      border-radius: 6px;
      outline: none;
      transition: box-shadow 0.2s;
    }
    #searchInput:focus {
      box-shadow: 0 0 0 2px #38bdf8;
    }
    #results {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #results li {
      margin-bottom: 10px;
    }
    #results li a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 16px;
      display: block;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    #results li a:hover {
      background-color: #475569;
    }
    #chat-panel {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    #chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1e293b;
      padding: 10px 20px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
    }
    #chat-title {
      font-size: 1.2em;
      font-weight: 600;
    }
    #call-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
      transition: background 0.2s;
    }
    #call-btn:hover svg {
      filter: brightness(1.3);
    }
    #messages {
      flex-grow: 1;
      overflow-y: auto;
      background-color: #1e293b;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 20px;
      list-style: none;
    }
    #messages li {
      position: relative;
      margin: 8px 0;
      padding: 10px 16px 20px 16px;
      border-radius: 10px;
      max-width: 70%;
      word-wrap: break-word;
      background-color: #334155;
      align-self: flex-start;
    }
    .own-message {
      background-color: #2563eb;
      color: #fff;
      align-self: flex-end;      /* Right side */
      margin-left: auto;
      margin-right: 0;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 10px;
    }
    .other-message {
      background-color: #334155;
      color: #fff;
      align-self: flex-start;    /* Left side */
      margin-right: auto;
      margin-left: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 10px;
    }
    .msg-meta {
      position: absolute;
      left: 12px;
      bottom: 4px;
      font-size: 0.75em;
      color: #cbd5e1;
    }
    #msg {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      flex-grow: 1;
      margin-right: 10px;
      background-color: #334155;
      color: white;
      box-sizing: border-box;
    }
    #msg_input {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      flex-grow: 1;
      margin-right: 10px;
      background-color: #334155;
      color: white;
      box-sizing: border-box;
      outline: none;
      transition: box-shadow 0.2s;
    }
    #msg_input:focus {
      box-shadow: 0 0 0 2px #38bdf8;
    }
    button {
      padding: 12px 20px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #1e40af;
    }
    #input-container {
      display: flex;
    }
    .day-divider {
      text-align: center;
      color: #94a3b8;
      background: none;
      font-size: 0.9em;
      margin: 16px 0 8px 0;
      padding: 0;
      border: none;
    }
    .selected {
      outline: 2px solid #38bdf8;
      background: #1e293b;
    }
    #msg-options {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    #msg-options button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.85em;
      cursor: pointer;
    }
    #msg-options button:hover {
      background: #1e40af;
    }
    .notif-badge {
      color: #f87171;
      font-size: 1.2em;
      margin-left: 6px;
      vertical-align: middle;
    }
    #video-call {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    video {
      width: 240px;
      max-width: 100%;
      border-radius: 10px;
      background: #222;
    }
  </style>
</head>
<body>

  <div id="user-panel">
    <h3>Search Users</h3>
    <input
      type="text"
      id="searchInput"
      onkeyup="searchUsers()"
      placeholder="Search users..."
      autocomplete="off"
    />
    <ul id="results"></ul>
    <button id="logout-btn" onclick="logout()" style="margin-top: 20px; padding: 10px 15px; border:none; border-radius:6px; background:#ef4444; color:white; cursor:pointer; width: 100%;">Logout</button>
  </div>

  <div id="chat-panel">
    <div id="chat-header">
      <span id="chat-title">Chat</span>
      <button id="call-btn" onclick="startCall()" title="Video Call">
        <svg width="28" height="28" fill="#38bdf8" viewBox="0 0 24 24"><path d="M17 10.5V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3.5l4 4v-11l-4 4z"/></svg>
      </button>
    </div>
    <ul id="messages"></ul>
    <div id="input-container">
      <form onsubmit="sendMessage(); return false;">
        <input id="msg_input" autocomplete="off" onkeydown="if(event.key === 'Enter') sendMessage();" />
        <button type="submit">Send</button>
      </form>
    </div>
    <div id="video-call">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>
  <script>
const socket = io(window.location.origin);
const username = "{{ username }}";

let currentRoom = '';
let previousRoom = '';
let targetUser = '';
let localStream, peerConnection;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const videoCallDiv = document.getElementById("video-call");

// Join last chat
socket.on('connect', () => {
  const lastTarget = localStorage.getItem('lastTargetUser');
  if (lastTarget) openChat(lastTarget);
});

window.addEventListener('beforeunload', () => {
  if (currentRoom) socket.emit('leave', { room: currentRoom });
});

socket.on('private_message', (msg) => {
  if (
    (msg.sender === targetUser && msg.recipient === username) ||
    (msg.sender === username && msg.recipient === targetUser)
  ) {
    displayMessage(msg);
    scrollMessagesToBottom();
  } else {
    showNotification(msg.sender);
  }
});

function searchUsers() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return document.getElementById('results').innerHTML = '';

  fetch(`/search_users?query=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      const results = document.getElementById('results');
      results.innerHTML = '';
      data.forEach(user => {
        if (user !== username) {
          const li = document.createElement('li');
          li.innerHTML = `<a href="#" onclick="openChat('${user}')">${user}</a>`;
          results.appendChild(li);
        }
      });
    });
}

function showNotification(user) {
  const results = document.getElementById('results');
  const items = results.querySelectorAll('li a');
  items.forEach(a => {
    if (a.textContent === user && !a.querySelector('.notif-badge')) {
      const badge = document.createElement('span');
      badge.className = 'notif-badge';
      badge.textContent = 'â€¢';
      a.appendChild(badge);
    }
  });
}

function openChat(user) {
  if (!user) return;

  targetUser = user;
  previousRoom = currentRoom;
  currentRoom = [username, targetUser].sort().join('_');

  document.getElementById('chat-title').innerText = `Chat with ${targetUser}`;
  document.getElementById('messages').innerHTML = '';

  // Remove notif badge
  document.querySelectorAll('li a').forEach(a => {
    if (a.textContent === targetUser) {
      const badge = a.querySelector('.notif-badge');
      if (badge) badge.remove();
    }
  });

  if (previousRoom && previousRoom !== currentRoom) {
    socket.emit('leave', { room: previousRoom });
  }

  socket.emit('join', { room: currentRoom });
  localStorage.setItem('lastTargetUser', user);
  loadMessages(user);
}

function loadMessages(user) {
  fetch(`/load_messages?target=${encodeURIComponent(user)}`)
    .then(res => res.json())
    .then(messages => {
      const messagesList = document.getElementById('messages');
      messagesList.innerHTML = '';
      let lastDate = '';
      messages.forEach(msg => {
        const msgDate = msg.timestamp.split(' ')[0];
        if (msgDate !== lastDate) {
          insertDayDivider(new Date(msgDate).toLocaleDateString());
          lastDate = msgDate;
        }
        displayMessage(msg);
      });
      scrollMessagesToBottom();
    });
}

function sendMessage() {
  const input = document.getElementById('msg_input');
  const text = input.value.trim();
  if (!text || !currentRoom) return;

  const msg = {
    room: currentRoom,
    sender: username,
    recipient: targetUser,
    text,
    timestamp: new Date().toLocaleString()
  };

  socket.emit('private_message', msg);
  displayMessage(msg);
  input.value = '';
}

function displayMessage(msg) {
  const li = document.createElement('li');
  li.className = msg.sender === username ? 'own-message' : 'other-message';
  li.innerHTML = `${msg.text} <span class="msg-meta">${msg.timestamp}</span>`;
  document.getElementById('messages').appendChild(li);
}

function insertDayDivider(dateText) {
  const divider = document.createElement('li');
  divider.className = 'day-divider';
  divider.textContent = dateText;
  document.getElementById('messages').appendChild(divider);
}

function scrollMessagesToBottom() {
  const messages = document.getElementById('messages');
  messages.scrollTop = messages.scrollHeight;
}

function logout() {
  localStorage.clear();
  window.location.href = '/logout';
}

// WebRTC Calling
async function startCall() {
  if (!targetUser) return alert("Select a user to call!");
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    videoCallDiv.style.display = "flex";

    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = ({ candidate }) => {
      if (candidate) socket.emit('ice-candidate', { candidate, room: currentRoom });
    };

    peerConnection.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    socket.emit('video-offer', { offer, room: currentRoom });

  } catch (err) {
    alert("Error starting call: " + err.message);
  }
}

socket.on('video-offer', async ({ offer }) => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    videoCallDiv.style.display = "flex";

    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = ({ candidate }) => {
      if (candidate) socket.emit('ice-candidate', { candidate, room: currentRoom });
    };

    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    socket.emit('video-answer', { answer, room: currentRoom });

  } catch (err) {
    alert("Error answering call: " + err.message);
  }
});

socket.on('video-answer', async ({ answer }) => {
  await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
});

socket.on('ice-candidate', ({ candidate }) => {
  peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
});
</script>

</body>
</html> 